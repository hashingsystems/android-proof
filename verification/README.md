
# Verification of an AndroidProof 

The python script 'attestation_verify.py' present in the verification folder,
performs a number of checks in order to verify an AndroidProof. 

To verify if an AndroidProof was generated by the released APK, pass the hashes output from the apk_validity.py to attestation_verify.py script, it expects 
the following format:
  
 ```bash
 python attestation_verify.py -f 'proof filename' -k 'googleApiKey' -ah 'apk hash' -ach 'apk signing cert hash' -hwa 'certicate chain filename' 
 ```
 
 Example:
 ```bash
 python attestation_verify.py -f AndroidProof_1481536143.proof -k AIzaSyCkruvXUsDIVCQubpimWlFFzDFKvv9E71Y -ah 8YGD8YPYGuVV6RmZMt9A5WmaKUjcEuJ01lKS08Hmmbg= -ach hbzPysrlsZGoqrBE/w/pWYU2l61erCU0Zmpm5/3Xdcg=  -hwa AndroidProof_1481536*.chain
 ```

# Advanced Verification

Google SafetyNet returns a signed attestation quote, reporting information
regarding the status of a device. Some of these information needs to be verified
externally in order to create a chain of trust completely excluding Oraclize.

In the repository, both the application source code and the compiled APK file used on the production
devices are distributed. Unfortunately, it is not trivial to derive the exact same APK from the source
code because: 

* The building environment needs to be the same
* The APK file includes the developer's signature

Nevertheless, this is possible thanks to the work done by OpenWhisper team for their Signal-Android
deterministic builds. We adapted their process to our needs, you can check their 
[guide](https://github.com/signalapp/Signal-Android/wiki/Reproducible-Builds) to have a better 
understanding of the process, but in short:

* The building processes is performed on a Docker instance based on a precise configuration
* The generated, unsigned APK and the distributed APK are compared and they are considered equal
  if they only differ for the lack of the signature

To build and run our image, execute the Dockerfile in the folder ``android-proof/deterministic_build/`` with the command:

```
docker run $(docker build --build-arg REPO_PATH=https://github.com/oraclize/android-proof.git --file Dockerfile_AndroidProof -q .)
```

Make sure to run the Dockerfile from its folder to be able to respect the paths for the apks to be compared.

If everything goes well you should get a message confirming that the APK initially supplied and the 
one generated locally from the source code do match.
